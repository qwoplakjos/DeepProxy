<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connecting…</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 50px;
    background: #333;
    color: white;
  }
  #status {
    margin-top: 20px;
  }
</style>
</head>
<body>
<h1>Connecting to the fastest server…</h1>
<div id="status">Checking available proxies…</div>

<script>
(async () => {
  const proxies = [
    { name: "Main CF", url: "https://deepclicker.cc" },
    { name: "GCore CDN", url: "https://gcore.deepclicker.cc" },
    { name: "Adaptive proxy", url: "https://2.deepclicker.cc" },
    { name: "Germany", url: "https://deepclick.u.cname.dev" }
  ];

  const HEALTH = "/test.txt";
  const TIMEOUT = 3000;
  const statusEl = document.getElementById("status");

  // Parse URL query
  const params = new URLSearchParams(window.location.search);
  let path = params.get("path") || "/";
  
  // Keep all other query parameters except "path"
  params.delete("path");
  const query = params.toString() ? `?${params.toString()}` : "";

  function checkProxy(proxy) {
    return new Promise((resolve, reject) => {
      const timer = setTimeout(() => reject(proxy), TIMEOUT);
      fetch(proxy.url + HEALTH, { cache: "no-store" })
        .then(resp => {
          clearTimeout(timer);
          if (resp.ok) resolve(proxy);
          else reject(proxy);
        })
        .catch(() => reject(proxy));
    });
  }

  const checks = proxies.map(proxy =>
    checkProxy(proxy).then(p => p).catch(() => null)
  );

  try {
    const result = await Promise.any(checks);
    if (result) {
      statusEl.innerText = "Connected via: " + result.name;
      window.location.replace(result.url + path + query);
    } else {
      statusEl.innerText = "All proxies unreachable.";
    }
  } catch {
    statusEl.innerText = "All proxies unreachable.";
  }
})();
</script>
</body>
</html>
